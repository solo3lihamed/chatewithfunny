# โ ุงูุญู ุงูููุงุฆู: ุฅุดุนุงุฑุงุช ุงูููุงููุงุช ุงูุนุงูุฉ

## ุงููุดููุฉ ุงูุชู ุชู ุญููุง

### ุงููุดููุฉ ุงูุณุงุจูุฉ โ
- ุงูุทุฑู ุงูุซุงูู ูุง ูุชููู ุฅุดุนุงุฑ ุงูููุงููุฉ
- ุงูุณุจุจ: ูุงู ุงูุฅุดุนุงุฑ ููุฑุณู ููุท ููู ูู ููุณ ุตูุญุฉ ุงูุฏุฑุฏุดุฉ
- ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุฃุฎุฑูุ ูุง ูุตูู ุงูุฅุดุนุงุฑ

### ุงูุญู ุงูุฌุฏูุฏ โ
- ุฅูุดุงุก WebSocket ุฎุงุต ููู ูุณุชุฎุฏู (User-Specific WebSocket)
- ุงูุฅุดุนุงุฑุงุช ุชุตู ูููุณุชุฎุฏู ูู ุฃู ุตูุญุฉ
- ูุนูู ุญุชู ูู ูุงู ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุงูุฃุตุฏูุงุก ุฃู ุงูุจุญุซ

---

## ููู ูุนูู ุงููุธุงู ุงูุฌุฏูุฏ

### 1. WebSocket ููุฅุดุนุงุฑุงุช ุงูุนุงูุฉ

**ููู ูุณุชุฎุฏู ูุณุฌู ุฏุฎูู:**
```javascript
// ูู base.html - ูุนูู ูู ุฌููุน ุงูุตูุญุงุช
ws://localhost:8000/ws/notifications/
```

**ูุชุตู ุชููุงุฆูุงู ุนูุฏ:**
- ุชุณุฌูู ุงูุฏุฎูู
- ูุชุญ ุฃู ุตูุญุฉ ูู ุงูุชุทุจูู
- ุงูุจูุงุก ูุชุตูุงู ุทูุงู ุงูุฌูุณุฉ

### 2. ูุธุงู ุงูุฅุดุนุงุฑุงุช

```
ุงููุชุตู (ahmed):
1. ูุถุบุท "๐ Call"
2. ูุชู ุฅูุดุงุก ุงูููุงููุฉ
3. ูุฑุณู ุฅุดุนุงุฑ ุฅูู: ws://user_[sara_id]/

ุงููุณุชูุจู (sara):
1. ูุชุตู ุจู ws://notifications/
2. ูุณุชูุจู ุงูุฅุดุนุงุฑ ููุฑุงู
3. ุชุธูุฑ ูุงูุฐุฉ ููุจุซูุฉ ูู ุฃู ุตูุญุฉ!
4. ููููู ูุจูู ุฃู ุฑูุถ ุงูููุงููุฉ
```

---

## ุงูููููุงุช ุงูุฌุฏูุฏุฉ

### 1. UserNotificationConsumer (Backend)

```python
# ูู consumers.py
class UserNotificationConsumer(AsyncWebsocketConsumer):
    """WebSocket ุฎุงุต ุจูู ูุณุชุฎุฏู ููุฅุดุนุงุฑุงุช"""
    
    async def connect(self):
        # ุฅูุดุงุก room ุฎุงุต ุจุงููุณุชุฎุฏู
        self.room_group_name = f'user_{self.user.id}'
        
    async def incoming_call_notification(self, event):
        # ุฅุฑุณุงู ุฅุดุนุงุฑ ุงูููุงููุฉ
        await self.send(...)
```

**ุงูููุฒุงุช:**
- โ Room ุฎุงุต ููู ูุณุชุฎุฏู: `user_{user_id}`
- โ ูุณุชูุจู ุฅุดุนุงุฑุงุช ุงูููุงููุงุช
- โ ูุนูู ูู ุฃู ุตูุญุฉ

### 2. ุชุญุฏูุซ ChatConsumer

```python
# ุนูุฏ ุฅุฑุณุงู ุฅุดุนุงุฑ ููุงููุฉ
elif message_type == 'incoming_call':
    receiver_id = await self.get_other_user_id()
    
    # ุฅุฑุณุงู ููู room ุงูุฎุงุต ุจุงููุณุชูุจู
    await self.channel_layer.group_send(
        f'user_{receiver_id}',  # โ ููุง ุงููุฑู!
        {
            'type': 'incoming_call_notification',
            'call_id': data.get('call_id'),
            'caller_username': self.user.username,
            'conversation_id': self.conversation_id
        }
    )
```

### 3. JavaScript ุงูุนุงู (base.html)

```javascript
// ูุนูู ูู ุฌููุน ุงูุตูุญุงุช
const notificationSocket = new WebSocket('.../ws/notifications/');

notificationSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    
    if (data.type === 'incoming_call') {
        showIncomingCallNotification(data);
    }
};

function showIncomingCallNotification(data) {
    // ุนุฑุถ ูุงูุฐุฉ ููุจุซูุฉ
    // ุฒุฑ Accept ูุฐูุจ ุฅูู ุตูุญุฉ ุงูุฏุฑุฏุดุฉ
    // ุฒุฑ Reject ูุฎูู ุงููุงูุฐุฉ
}
```

---

## ุณููุงุฑูู ุงูุงุณุชุฎุฏุงู ุงููุงูู

### ุงูุญุงูุฉ 1: ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุงูุฏุฑุฏุดุฉ
```
ahmed: ูู /chat/1/ ูุน sara
ahmed: ูุถุบุท "๐ Call"

sara: ูู /chat/1/ ูุน ahmed
sara: ุชุธูุฑ ูุงูุฐุฉ ููุจุซูุฉ ููุฑุงู
sara: ุชุถุบุท "โ Accept"
sara: ุชุจุฏุฃ ุงูููุงููุฉ!
```

### ุงูุญุงูุฉ 2: ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุฃุฎุฑู โจ
```
ahmed: ูู /chat/1/ ูุน sara
ahmed: ูุถุบุท "๐ Call"

sara: ูู /friends/ (ุตูุญุฉ ุงูุฃุตุฏูุงุก)
sara: ุชุธูุฑ ูุงูุฐุฉ ููุจุซูุฉ ููุฑุงู! โ
sara: ุชุถุบุท "โ Accept"
sara: ูุชู ุชูุฌูููุง ุฅูู /chat/1/
sara: ุชุจุฏุฃ ุงูููุงููุฉ!
```

### ุงูุญุงูุฉ 3: ุงููุณุชุฎุฏู ูู ุฃู ููุงู
```
ahmed: ูู /chat/1/
ahmed: ูุถุบุท "๐ Call"

sara: ูู /search/ ุฃู /profile/ ุฃู ุฃู ุตูุญุฉ
sara: ุชุธูุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ! โ
sara: ูููููุง ูุจูู ุฃู ุฑูุถ ุงูููุงููุฉ
```

---

## ุงููููุงุช ุงููุญุฏุซุฉ

### 1. consumers.py
```
โ ุฅุถุงูุฉ UserNotificationConsumer
โ ุชุญุฏูุซ ChatConsumer.receive()
โ ุฅุถุงูุฉ get_other_user_id()
```

### 2. routing.py
```
โ ุฅุถุงูุฉ ูุณุงุฑ: ws/notifications/
```

### 3. base.html
```
โ ุฅุถุงูุฉ WebSocket ููุฅุดุนุงุฑุงุช
โ ุฅุถุงูุฉ showIncomingCallNotification()
โ ูุนูู ูู ุฌููุน ุงูุตูุญุงุช
```

---

## ุงูุงุฎุชุจุงุฑ

### ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ ุงูุดุงููุฉ

#### 1. ุงูุชุญ ูุงูุฐุชูู
```
ูุงูุฐุฉ 1: ุชุณุฌูู ุฏุฎูู ูู "ahmed"
ูุงูุฐุฉ 2: ุชุณุฌูู ุฏุฎูู ูู "sara"
```

#### 2. ุชุฃูุฏ ูู ุงูุงุชุตุงู
```
ุงูุชุญ Console ูู ููุง ุงููุงูุฐุชูู
ูุฌุจ ุฃู ุชุฑู:
โ "Notification WebSocket connected"
```

#### 3. ุงุฎุชุจุงุฑ ูู ููุณ ุงูุตูุญุฉ
```
ูุงูุฐุฉ 1 (ahmed): ุงุฐูุจ ุฅูู /chat/1/ ูุน sara
ูุงูุฐุฉ 2 (sara): ุงุฐูุจ ุฅูู /chat/1/ ูุน ahmed

ahmed: ุงุถุบุท "๐ Call"
sara: ูุฌุจ ุฃู ุชุธูุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ ููุฑุงู! โ
```

#### 4. ุงุฎุชุจุงุฑ ูู ุตูุญุฉ ูุฎุชููุฉ โญ
```
ูุงูุฐุฉ 1 (ahmed): ูู /chat/1/
ูุงูุฐุฉ 2 (sara): ูู /friends/ ุฃู /search/

ahmed: ุงุถุบุท "๐ Call"
sara: ูุฌุจ ุฃู ุชุธูุฑ ุงููุงูุฐุฉ ุงูููุจุซูุฉ! โ
sara: ุงุถุบุท "โ Accept"
sara: ูุชู ุชูุฌูููุง ุฅูู /chat/1/
sara: ุชุจุฏุฃ ุงูููุงููุฉ!
```

---

## ูุฑุงูุจุฉ ุงูุฃุฎุทุงุก

### ูู Console

**ูุฌุจ ุฃู ุชุฑู:**
```javascript
โ Notification WebSocket connected
โ Chat WebSocket connected (ูู ุตูุญุฉ ุงูุฏุฑุฏุดุฉ)
```

**ุฅุฐุง ุฑุฃูุช:**
```javascript
โ WebSocket connection failed
โ 403 Forbidden
```

**ุงูุญู:**
```
1. ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู
2. ุฃุนุฏ ุชุดุบูู Daphne
3. ุชุญูู ูู Console ููุฃุฎุทุงุก
```

---

## ุงูููุฒุงุช ุงูููุงุฆูุฉ โ

### ูุธุงู ุงูุฅุดุนุงุฑุงุช
- โ WebSocket ุฎุงุต ููู ูุณุชุฎุฏู
- โ ูุนูู ูู ุฃู ุตูุญุฉ
- โ ุฅุนุงุฏุฉ ุงุชุตุงู ุชููุงุฆูุฉ
- โ ูุงุฌูุฉ ููุจุซูุฉ ุฌูููุฉ

### ุงูููุงููุงุช ุงูุตูุชูุฉ
- โ ุฅุดุนุงุฑ ููุฑู ูููุณุชูุจู
- โ ูุจูู/ุฑูุถ ุงูููุงููุฉ
- โ ุชูุฌูู ุชููุงุฆู ูุตูุญุฉ ุงูุฏุฑุฏุดุฉ
- โ WebRTC ููุตูุช

### ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
- โ ูุง ุญุงุฌุฉ ูุชุญุฏูุซ ุงูุตูุญุฉ
- โ ุฅุดุนุงุฑุงุช ูู ุงูููุช ุงููุนูู
- โ ูุงุฌูุฉ ุณููุฉ ูุฌูููุฉ
- โ ูุนูู ูู ูู ููุงู

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

**ุงูุขู ุงูููุงููุงุช ุชุนูู ุจุดูู ูุซุงูู:**
1. โ ุงููุชุตู ูุจุฏุฃ ุงูููุงููุฉ
2. โ ุงููุณุชูุจู ูุชููู ุฅุดุนุงุฑ ููุฑู (ูู ุฃู ุตูุญุฉ!)
3. โ ุงููุณุชูุจู ููุจู/ูุฑูุถ
4. โ ุงูููุงููุฉ ุชุจุฏุฃ ุจูุฌุงุญ
5. โ ุงูุตูุช ูุนูู ุจุดูู ูุงุถุญ

**ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงููุงูู!** ๐๐โจ
