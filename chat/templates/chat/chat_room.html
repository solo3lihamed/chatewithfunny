{% extends 'chat/base.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.username }} - FunnyChat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: grid;
        grid-template-rows: auto 1fr auto;
        height: calc(100vh - 200px);
        gap: 1rem;
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: rgba(15, 52, 96, 0.7);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
    }

    .chat-messages {
        overflow-y: auto;
        padding: 1rem;
        background: rgba(15, 52, 96, 0.3);
        border-radius: var(--border-radius);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chat-input-container {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: rgba(15, 52, 96, 0.7);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
    }

    .message-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 0.5rem;
    }

    .message-wrapper.sent {
        justify-content: flex-end;
    }

    .message-wrapper.received {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 70%;
    }

    .message-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.3rem;
    }

    .media-preview {
        max-width: 300px;
        border-radius: var(--border-radius-sm);
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span
                class="status-indicator {% if other_user.is_online %}status-online{% else %}status-offline{% endif %}"></span>
            {% if other_user.avatar %}
            <img src="{{ other_user.avatar.url }}" alt="Avatar" class="avatar">
            {% else %}
            <div class="avatar" style="display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                {{ other_user.username.0|upper }}
            </div>
            {% endif %}
            <div>
                <h3 style="margin: 0;">{{ other_user.username }}</h3>
                <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);" id="user-status">
                    {% if other_user.is_online %}Online{% else %}Offline{% endif %}
                </p>
            </div>
        </div>
        <button onclick="initiateCall()" class="btn btn-success">ðŸ“ž Call</button>
    </div>

    <div class="chat-messages" id="chat-messages">
        {% for msg in messages %}
        <div class="message-wrapper {% if msg.sender == user %}sent{% else %}received{% endif %}">
            <div class="message-content">
                <div
                    class="message-bubble {% if msg.sender == user %}message-sent{% else %}message-received{% endif %}">
                    {{ msg.content }}
                    {% for attachment in msg.attachments.all %}
                    {% if attachment.attachment_type == 'image' %}
                    <img src="{{ attachment.file.url }}" alt="Image" class="media-preview">
                    {% elif attachment.attachment_type == 'video' %}
                    <video controls class="media-preview">
                        <source src="{{ attachment.file.url }}">
                    </video>
                    {% elif attachment.attachment_type == 'audio' %}
                    <audio controls style="width: 100%; margin-top: 0.5rem;">
                        <source src="{{ attachment.file.url }}">
                    </audio>
                    {% endif %}
                    {% endfor %}
                </div>
                <div class="message-time">
                    {{ msg.created_at|date:"H:i" }}
                </div>
            </div>
        </div>
        {% endfor %}
        <div id="typing-indicator" style="display: none;">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <div class="chat-input-container">
        <input type="file" id="file-input" style="display: none;" accept="image/*,video/*,audio/*">
        <button onclick="document.getElementById('file-input').click()" class="btn btn-secondary">ðŸ“Ž</button>
        <input type="text" id="message-input" class="form-control" placeholder="Type a message..."
            style="margin-bottom: 0;">
        <button onclick="sendMessage()" class="btn btn-primary">ðŸš€ Send</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'chat/js/chat.js' %}"></script>
<script src="{% static 'chat/js/call.js' %}"></script>
<script>
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ user.id }};
    const otherUserId = {{ other_user.id }};
    const otherUsername = "{{ other_user.username }}";

    // Initialize chat WebSocket
    initializeChat(conversationId, currentUserId);

    // File upload handler
    document.getElementById('file-input').addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
            uploadFile(e.target.files[0], conversationId);
        }
    });

    // Enter key to send
    document.getElementById('message-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Typing indicator
    let typingTimeout;
    document.getElementById('message-input').addEventListener('input', function () {
        sendTypingIndicator(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            sendTypingIndicator(false);
        }, 1000);
    });
</script>
{% endblock %}